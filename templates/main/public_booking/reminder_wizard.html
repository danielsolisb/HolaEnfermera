{% extends 'layouts/wizard_base.html' %}
{% load static %}

{% block content %}

<!-- BARRA DE PROGRESO -->
<div class="mb-8">
    <div class="flex justify-between items-center relative">
        <div class="absolute left-0 top-1/2 w-full h-1 bg-gray-200 -z-10"></div>
        
        <!-- Paso 1 -->
        <div id="dot-1" class="step-dot w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold border-4 border-white transition-colors">1</div>
        <!-- Paso 2 -->
        <div id="dot-2" class="step-dot w-10 h-10 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold border-4 border-white transition-colors">2</div>
        <!-- Paso 3 -->
        <div id="dot-3" class="step-dot w-10 h-10 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold border-4 border-white transition-colors">3</div>
    </div>
    <div class="flex justify-between text-xs text-gray-500 mt-2 px-1 font-medium">
        <span>Tratamiento</span>
        <span>Experiencia</span>
        <span>Datos</span>
    </div>
</div>

<form id="leadForm">
    {% csrf_token %}
    
    <!-- ================= PASO 1: MEDICAMENTO ================= -->
    <div id="step-1" class="step-content active">
        <h2 class="text-2xl font-bold text-gray-800 mb-1">¿Qué te aplicaste?</h2>
        <p class="text-gray-500 mb-6 text-sm">Selecciona el medicamento para calcular tu próxima dosis.</p>

        <!-- Input Buscador -->
        <div class="mb-6 relative">
            <label class="block text-gray-700 text-sm font-bold mb-2">Nombre del Medicamento</label>
            <div class="relative">
                <input type="text" id="medSearch" class="w-full p-4 pl-10 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-lg shadow-sm" placeholder="Escribe para buscar..." autocomplete="off">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>
            <input type="hidden" id="medId" name="medicamento_id">
            <input type="hidden" id="medTexto" name="medicamento_texto">
            
            <!-- Lista desplegable -->
            <ul id="medResults" class="hidden absolute z-20 w-full bg-white border border-gray-200 rounded-xl mt-1 shadow-xl max-h-60 overflow-y-auto"></ul>
            
            <!-- Opción Manual -->
            <div class="mt-3 flex items-center">
                <input type="checkbox" id="medManualCheck" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                <label for="medManualCheck" class="ml-2 text-sm text-gray-600">No encuentro mi medicamento</label>
            </div>
        </div>

        <!-- Fecha Aplicación -->
        <div class="mb-8">
            <label class="block text-gray-700 text-sm font-bold mb-2">¿Cuándo fue la última aplicación?</label>
            <input type="date" id="dateApp" name="fecha_aplicacion" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg shadow-sm">
        </div>

        <button type="button" id="btnNext1" disabled onclick="nextStep(2)" class="w-full bg-gray-300 text-gray-500 font-bold py-4 rounded-xl text-lg shadow-none transition cursor-not-allowed">
            Siguiente <i class="fas fa-arrow-right ml-2"></i>
        </button>
    </div>

    <!-- ================= PASO 2: CALIDAD (ENFERMERO + RATING) ================= -->
    <div id="step-2" class="step-content hidden">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Tu Experiencia</h2>
            <p class="text-gray-500 text-sm">Ayúdanos a reconocer al profesional.</p>
        </div>

        <!-- 1. Selección de Enfermero -->
        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-3">¿Quién te atendió?</label>
            
            <!-- Grid de Enfermeros (Se llena con AJAX) -->
            <div id="nurseGrid" class="grid grid-cols-2 gap-3 max-h-60 overflow-y-auto p-1">
                <div class="col-span-2 text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>Cargando enfermeros...
                </div>
            </div>
            <input type="hidden" id="nurseId" name="enfermero_id">
            <p id="nurseError" class="text-red-500 text-xs mt-1 hidden">Debes seleccionar un enfermero.</p>
        </div>

        <!-- 2. Calificación (Estrellas) -->
        <div class="mb-8 text-center bg-white p-6 rounded-xl border border-gray-100 shadow-sm">
            <label class="block text-gray-700 text-sm font-bold mb-3">Califica el servicio</label>
            <div class="flex justify-center space-x-2" id="starContainer">
                <!-- Estrellas generadas dinámicamente o estáticas -->
                <button type="button" class="star-btn text-4xl text-gray-300 transition transform hover:scale-110 focus:outline-none" data-value="1">★</button>
                <button type="button" class="star-btn text-4xl text-gray-300 transition transform hover:scale-110 focus:outline-none" data-value="2">★</button>
                <button type="button" class="star-btn text-4xl text-gray-300 transition transform hover:scale-110 focus:outline-none" data-value="3">★</button>
                <button type="button" class="star-btn text-4xl text-gray-300 transition transform hover:scale-110 focus:outline-none" data-value="4">★</button>
                <button type="button" class="star-btn text-4xl text-gray-300 transition transform hover:scale-110 focus:outline-none" data-value="5">★</button>
            </div>
            <input type="hidden" id="ratingValue" name="rating">
            <p id="ratingText" class="text-sm text-blue-600 font-semibold mt-2 h-5"></p>
        </div>

        <!-- Botones Navegación -->
        <div class="flex space-x-3">
            <button type="button" onclick="prevStep(1)" class="w-1/3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-4 rounded-xl text-lg transition">
                Atrás
            </button>
            <button type="button" id="btnNext2" disabled onclick="nextStep(3)" class="w-2/3 bg-gray-300 text-gray-500 font-bold py-4 rounded-xl text-lg shadow-none transition cursor-not-allowed">
                Siguiente
            </button>
        </div>
    </div>

    <!-- ================= PASO 3: DATOS (Placeholder) ================= -->
    <div id="step-3" class="step-content hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-1">Tus Datos</h2>
        <p class="text-gray-500 mb-6 text-sm">Para enviarte el recordatorio.</p>
        <p class="text-center py-10 text-gray-400">Contenido de la Fase 3 en construcción...</p>
        <button type="button" onclick="prevStep(2)" class="text-gray-500 underline w-full text-center">Volver</button>
    </div>

</form>

{% endblock %}

{% block extra_js %}
<script>
    // --- DATA INICIAL ---
    const catalogoMedicamentos = {{ medicamentos|safe }}; 
    let enfermerosCargados = false;

    // --- ELEMENTOS DOM ---
    // Paso 1
    const searchInput = document.getElementById('medSearch');
    const medList = document.getElementById('medResults');
    const dateInput = document.getElementById('dateApp');
    const medManualCheck = document.getElementById('medManualCheck');
    const hiddenMedId = document.getElementById('medId');
    const hiddenMedTexto = document.getElementById('medTexto');
    const btnNext1 = document.getElementById('btnNext1');

    // Paso 2
    const nurseGrid = document.getElementById('nurseGrid');
    const hiddenNurseId = document.getElementById('nurseId');
    const hiddenRating = document.getElementById('ratingValue');
    const ratingText = document.getElementById('ratingText');
    const starBtns = document.querySelectorAll('.star-btn');
    const btnNext2 = document.getElementById('btnNext2');

    // ================= LÓGICA PASO 1 (MEDICAMENTO) =================
    
    // 1. Configurar fecha máxima (hoy)
    const today = new Date().toISOString().split('T')[0];
    dateInput.max = today;
    dateInput.value = today;

    // 2. Buscador
    searchInput.addEventListener('input', function(e) {
        const val = e.target.value.toLowerCase();
        medList.innerHTML = '';
        hiddenMedId.value = ''; 
        
        if (val.length > 0) {
            const filtered = catalogoMedicamentos.filter(m => m.nombre.toLowerCase().includes(val));
            if (filtered.length > 0) {
                medList.classList.remove('hidden');
                filtered.forEach(med => {
                    const li = document.createElement('li');
                    li.className = "px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 text-gray-700";
                    li.textContent = med.nombre;
                    li.onclick = () => {
                        searchInput.value = med.nombre;
                        hiddenMedId.value = med.id;
                        hiddenMedTexto.value = med.nombre;
                        medList.classList.add('hidden');
                        validateStep1();
                    };
                    medList.appendChild(li);
                });
            } else {
                medList.classList.add('hidden');
            }
        } else {
            medList.classList.add('hidden');
        }
        // Si escribe manual, guardamos el texto
        hiddenMedTexto.value = searchInput.value;
        validateStep1();
    });

    // 3. Checkbox Manual
    medManualCheck.addEventListener('change', function() {
        if (this.checked) {
            searchInput.value = '';
            searchInput.placeholder = "Escribe el nombre del medicamento...";
            searchInput.disabled = false; // Permitir escribir libremente
            hiddenMedId.value = ''; // Sin ID
            searchInput.focus();
        } else {
            searchInput.value = '';
            searchInput.placeholder = "Busca en la lista...";
        }
        validateStep1();
    });

    function validateStep1() {
        const hasDate = dateInput.value !== '';
        // Valido si tiene ID (catálogo) O si tiene texto (manual y checkbox activado o texto libre)
        const hasMed = hiddenMedId.value !== '' || (searchInput.value.length > 2);
        
        if (hasMed && hasDate) {
            enableBtn(btnNext1);
        } else {
            disableBtn(btnNext1);
        }
    }
    
    dateInput.addEventListener('change', validateStep1);


    // ================= LÓGICA PASO 2 (ENFERMERO + RATING) =================

    // 1. Cargar Enfermeros (Solo la primera vez)
    function loadNurses() {
        if (enfermerosCargados) return;
        
        fetch('/api/nurses/')
            .then(response => response.json())
            .then(data => {
                nurseGrid.innerHTML = '';
                if (data.status === 'success' && data.enfermeros.length > 0) {
                    data.enfermeros.forEach(enf => {
                        // Tarjeta de Enfermero
                        const card = document.createElement('div');
                        card.className = 'selectable-card border-2 border-gray-200 rounded-xl p-3 flex flex-col items-center cursor-pointer transition hover:border-blue-300 bg-white';
                        card.onclick = () => selectNurse(card, enf.id);
                        
                        // Imagen
                        const img = document.createElement('img');
                        // Fallback si no tiene foto
                        img.src = enf.foto ? enf.foto : '{% static "img/profile-photos/user.png" %}'; 
                        img.className = 'w-16 h-16 rounded-full object-cover mb-2 border border-gray-100';
                        
                        // Nombre
                        const name = document.createElement('span');
                        name.className = 'text-sm font-semibold text-gray-700 text-center leading-tight';
                        name.textContent = enf.nombre;
                        
                        card.appendChild(img);
                        card.appendChild(name);
                        nurseGrid.appendChild(card);
                    });
                    enfermerosCargados = true;
                } else {
                    nurseGrid.innerHTML = '<p class="col-span-2 text-center text-gray-500">No hay enfermeros disponibles.</p>';
                }
            })
            .catch(err => {
                console.error(err);
                nurseGrid.innerHTML = '<p class="col-span-2 text-center text-red-500">Error al cargar enfermeros.</p>';
            });
    }

    // 2. Seleccionar Enfermero
    function selectNurse(cardElement, id) {
        // Quitar selección previa
        document.querySelectorAll('.selectable-card').forEach(c => c.classList.remove('selected', 'border-blue-600', 'bg-blue-50'));
        
        // Activar actual
        cardElement.classList.add('selected', 'border-blue-600', 'bg-blue-50');
        hiddenNurseId.value = id;
        validateStep2();
    }

    // 3. Calificación (Estrellas)
    const ratingLabels = ["Malo", "Regular", "Bueno", "Muy Bueno", "Excelente"];
    
    starBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const val = parseInt(this.getAttribute('data-value'));
            hiddenRating.value = val;
            ratingText.textContent = ratingLabels[val - 1];
            
            // Pintar estrellas
            starBtns.forEach(s => {
                const sVal = parseInt(s.getAttribute('data-value'));
                if (sVal <= val) {
                    s.classList.remove('text-gray-300');
                    s.classList.add('text-yellow-400');
                } else {
                    s.classList.add('text-gray-300');
                    s.classList.remove('text-yellow-400');
                }
            });
            validateStep2();
        });
    });

    function validateStep2() {
        if (hiddenNurseId.value && hiddenRating.value) {
            enableBtn(btnNext2);
        } else {
            disableBtn(btnNext2);
        }
    }


    // ================= UTILIDADES DE NAVEGACIÓN =================
    
    function nextStep(stepNumber) {
        // Ocultar todos
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
        // Mostrar el actual
        document.getElementById(`step-${stepNumber}`).classList.remove('hidden');
        
        // Actualizar barra
        updateProgressBar(stepNumber);
        
        // Acciones específicas
        if (stepNumber === 2) {
            loadNurses(); // Cargar API
        }
    }

    function prevStep(stepNumber) {
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`step-${stepNumber}`).classList.remove('hidden');
        updateProgressBar(stepNumber);
    }

    function updateProgressBar(step) {
        for (let i = 1; i <= 3; i++) {
            const dot = document.getElementById(`dot-${i}`);
            if (i < step) { // Pasos completados
                dot.className = 'step-dot w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold border-4 border-white transition-colors';
                dot.innerHTML = '<i class="fas fa-check"></i>';
            } else if (i === step) { // Paso actual
                dot.className = 'step-dot w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold border-4 border-white transition-colors shadow-lg';
                dot.innerHTML = i;
            } else { // Futuro
                dot.className = 'step-dot w-10 h-10 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold border-4 border-white transition-colors';
                dot.innerHTML = i;
            }
        }
    }

    function enableBtn(btn) {
        btn.disabled = false;
        btn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
        btn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'shadow-lg');
    }

    function disableBtn(btn) {
        btn.disabled = true;
        btn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
        btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'shadow-lg');
    }
</script>
{% endblock %}