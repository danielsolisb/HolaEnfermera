{% extends 'layouts/wizard_base.html' %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">Es necesario que llene todos los datos para que llegue su recordatorio</h2>
</div>

{% if error %}
<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
    <p class="font-bold">Error</p>
    <p>{{ error }}</p>
</div>
{% endif %}

<form method="POST" action="{% url 'public_reminder_patient' %}" id="finalForm" class="space-y-5">
    {% csrf_token %}

    <div>
        <label class="block text-gray-700 text-xs font-bold mb-1">Cédula de Identidad</label>
        <div class="relative">
            <input type="tel" name="cedula" id="cedula" 
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono tracking-wider" 
                   placeholder="Ej: 099..." maxlength="10" required value="{{ data.cedula|default:'' }}">
            <div id="cedulaLoader" class="absolute right-3 top-3 hidden text-blue-500">
                <i class="fas fa-circle-notch fa-spin"></i>
            </div>
        </div>
        <p id="userMsg" class="text-xs mt-1 h-4 font-medium"></p>
    </div>

    <div id="dataFields" class="space-y-4 opacity-50 pointer-events-none transition-opacity duration-300">
        
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-700 text-xs font-bold mb-1">Nombres</label>
                <input type="text" name="nombres" id="nombres" class="w-full p-3 border border-gray-300 rounded-lg" required>
            </div>
            <div>
                <label class="block text-gray-700 text-xs font-bold mb-1">Apellidos</label>
                <input type="text" name="apellidos" id="apellidos" class="w-full p-3 border border-gray-300 rounded-lg" required>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-700 text-xs font-bold mb-1">Fecha Nacimiento</label>
                <input type="date" name="fecha_nacimiento" id="fecha_nacimiento" class="w-full p-3 border border-gray-300 rounded-lg" required>
            </div>
            <div>
                <label class="block text-gray-700 text-xs font-bold mb-1">Ciudad</label>
                <input type="text" name="ciudad" id="ciudad" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Ej: Guayaquil" required>
            </div>
        </div>

        <div>
            <label class="block text-gray-700 text-xs font-bold mb-1">Correo Electrónico</label>
            <input type="email" name="email" id="email" class="w-full p-3 border border-gray-300 rounded-lg" required>
        </div>

        <div>
            <label class="block text-gray-700 text-xs font-bold mb-1">Teléfono Celular</label>
            <input type="tel" name="telefono" id="telefono" class="w-full p-3 border border-gray-300 rounded-lg" required>
        </div>
    </div>

    <div class="pt-4 flex space-x-3">
        <a href="{% url 'public_reminder_experience' %}" class="w-1/3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl text-center flex items-center justify-center">
            Atrás
        </a>
        <button type="submit" id="btnFinal" class="w-2/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition">
            Finalizar
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    const cedulaInput = document.getElementById('cedula');
    const fieldsContainer = document.getElementById('dataFields');
    const msg = document.getElementById('userMsg');
    let timeout = null;

    cedulaInput.addEventListener('input', function() {
        const val = this.value;
        clearTimeout(timeout);
        msg.innerText = '';
        
        if (val.length >= 10) {
            document.getElementById('cedulaLoader').classList.remove('hidden');
            
            timeout = setTimeout(() => {
                const apiUrl = "{% url 'api_check_user' %}";
                fetch(`${apiUrl}?cedula=${val}`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('cedulaLoader').classList.add('hidden');
                        
                        if (data.exists === true) {
                            msg.innerText = `Hola ${data.user.nombres}, actualicemos tus datos.`;
                            msg.className = "text-xs mt-1 h-4 font-medium text-green-600";
                            
                            // Llenar campos
                            document.getElementById('nombres').value = data.user.nombres || '';
                            document.getElementById('apellidos').value = data.user.apellidos || '';
                            document.getElementById('email').value = data.user.email || '';
                            document.getElementById('telefono').value = data.user.telefono || '';
                            
                            // Llenar nuevos campos
                            document.getElementById('fecha_nacimiento').value = data.user.fecha_nacimiento || '';
                            document.getElementById('ciudad').value = data.user.ciudad || '';

                            unlockFields();
                        } else {
                            msg.innerText = "Usuario nuevo. Por favor completa tu perfil.";
                            msg.className = "text-xs mt-1 h-4 font-medium text-blue-600";
                            // Limpiar por seguridad
                            document.querySelectorAll('#dataFields input').forEach(i => i.value = '');
                            unlockFields();
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        document.getElementById('cedulaLoader').classList.add('hidden');
                        unlockFields();
                    });
            }, 800);
        }
    });

    function unlockFields() {
        fieldsContainer.classList.remove('opacity-50', 'pointer-events-none');
    }
</script>
{% endblock %}