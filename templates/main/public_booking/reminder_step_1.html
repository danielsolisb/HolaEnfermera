{% extends 'layouts/wizard_base.html' %}

{% block content %}
<div class="mb-6">
    <!-- Indicador Visual -->
    <div class="flex items-center justify-between mb-8">
        <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-lg ring-4 ring-blue-100">1</div>
        <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
        <div class="w-10 h-10 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center font-bold">2</div>
        <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
        <div class="w-10 h-10 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center font-bold">3</div>
    </div>

    <h2 class="text-2xl font-bold text-gray-800 mb-2">¿Qué medicamento te aplicaste?</h2>
    <p class="text-gray-500 text-sm mb-6">Calcularemos tu próxima dosis automáticamente.</p>
</div>

<form method="POST" action="{% url 'reminder_step_1' %}" class="space-y-6">
    {% csrf_token %}

    <!-- Buscador Inteligente -->
    <div class="relative">
        <label class="block text-gray-700 text-sm font-bold mb-2">Nombre del Medicamento</label>
        <input type="text" id="medSearch" name="medicamento_texto" 
               class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-lg shadow-sm"
               placeholder="Ej: Neurobión..." required autocomplete="off"
               value="{{ request.session.reminder_data.medicamento_texto|default:'' }}">
        
        <input type="hidden" id="medId" name="medicamento_id" value="{{ request.session.reminder_data.medicamento_id|default:'' }}">
        
        <!-- Lista de Resultados -->
        <ul id="medResults" class="hidden absolute z-10 w-full bg-white border border-gray-200 rounded-xl mt-1 shadow-xl max-h-60 overflow-y-auto"></ul>
    </div>

    <!-- Fecha -->
    <div>
        <label class="block text-gray-700 text-sm font-bold mb-2">Fecha de última aplicación</label>
        <input type="date" name="fecha_aplicacion" id="dateApp"
               class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg shadow-sm"
               required value="{{ request.session.reminder_data.fecha_aplicacion|default:'' }}">
    </div>

    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg transition transform hover:-translate-y-1">
        Siguiente <i class="fas fa-arrow-right ml-2"></i>
    </button>
</form>
{% endblock %}

{% block extra_js %}
<script>
    // Lógica simple para el autocompletado
    const medicamentos = {{ medicamentos_json|safe }};
    const searchInput = document.getElementById('medSearch');
    const resultsList = document.getElementById('medResults');
    const hiddenId = document.getElementById('medId');

    // Configurar fecha máxima hoy
    document.getElementById('dateApp').max = new Date().toISOString().split('T')[0];

    searchInput.addEventListener('input', function(e) {
        const val = this.value.toLowerCase();
        resultsList.innerHTML = '';
        hiddenId.value = ''; // Resetear ID si escribe

        if (val.length > 1) {
            const filtered = medicamentos.filter(m => m.nombre.toLowerCase().includes(val));
            if (filtered.length > 0) {
                resultsList.classList.remove('hidden');
                filtered.forEach(med => {
                    const li = document.createElement('li');
                    li.className = "px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 text-gray-700";
                    li.textContent = med.nombre;
                    li.onclick = () => {
                        searchInput.value = med.nombre;
                        hiddenId.value = med.id;
                        resultsList.classList.add('hidden');
                    };
                    resultsList.appendChild(li);
                });
            } else {
                resultsList.classList.add('hidden');
            }
        } else {
            resultsList.classList.add('hidden');
        }
    });
    
    // Cerrar lista si clic fuera
    document.addEventListener('click', function(e) {
        if (e.target !== searchInput) resultsList.classList.add('hidden');
    });
</script>
{% endblock %}