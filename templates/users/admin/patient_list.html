{% extends 'layouts/dashboard_base.html' %}
{% load static %}

{% block title %}Pacientes{% endblock %}
{% block page_title %}Directorio de Pacientes{% endblock %}
{% block breadcrumb %}<li class="active">Pacientes</li>{% endblock %}

{% block extra_css %}
    <link href="{% static 'plugins/datatables/media/css/dataTables.bootstrap.css' %}" rel="stylesheet">
    <link href="{% static 'plugins/datatables/extensions/Responsive/css/responsive.dataTables.min.css' %}" rel="stylesheet">
    <style>
        .dataTables_filter { text-align: right; }
        .dataTables_paginate { text-align: right; }
        /* Ajuste para que los botones de acción no se rompan */
        .btn-action-group { white-space: nowrap; }
    </style>
{% endblock %}

{% block content %}
<div class="panel">
    <div class="panel-heading">
        <div class="panel-control">
            <a href="{% url 'admin_patient_create' %}" class="btn btn-primary">
                <i class="demo-pli-add"></i> Nuevo Paciente
            </a>
        </div>
        <h3 class="panel-title">Base de Datos de Clientes</h3>
    </div>

    <div class="panel-body">
        <table id="demo-dt-basic" class="table table-striped table-bordered" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th style="width: 20%;">Paciente</th> 
                    
                    <th style="width: 15%;">Cédula</th>
                    <th style="width: 20%;">Contacto</th>
                    <th style="width: 30%;" class="min-desktop">Ubicación</th>
                    
                    <th class="text-center" style="width: 15%;" data-orderable="false">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for p in pacientes %}
                <tr>
                    <td>
                        <div class="media-left">
                            {% if p.foto %}
                                <img src="{{ p.foto.url }}" class="img-circle img-sm" alt="Perfil">
                            {% else %}
                                <img src="{% static 'img/profile-photos/user.png' %}" class="img-circle img-sm" alt="Perfil">
                            {% endif %}
                        </div>
                        <div class="media-body" style="vertical-align: middle;">
                            <span class="text-bold text-main">{{ p.get_full_name }}</span>
                            <br>
                            <small class="text-muted">Reg: {{ p.date_joined|date:"d/m/Y" }}</small>
                        </div>
                    </td>
                    <td style="vertical-align: middle;">
                        <span class="text-semibold">{{ p.cedula }}</span>
                    </td>
                    <td style="vertical-align: middle;">
                        <i class="fa fa-phone"></i> {{ p.telefono }}<br>
                        <i class="fa fa-envelope-o"></i> <small>{{ p.email }}</small>
                    </td>
                    <td style="vertical-align: middle;">
                        {{ p.perfil_cliente.ciudad|default:"--" }}
                        <br><small class="text-muted">{{ p.perfil_cliente.direccion|truncatechars:40 }}</small>
                    </td>
                    
                    <td class="text-center" style="vertical-align: middle;">
                        <div class="btn-group btn-action-group">
                            <button class="btn btn-sm btn-default btn-hover-info btn-view-details" 
                                    data-toggle="modal" data-target="#modal-patient-details"
                                    data-img="{% if p.foto %}{{ p.foto.url }}{% else %}{% static 'img/profile-photos/user.png' %}{% endif %}"
                                    data-name="{{ p.get_full_name }}"
                                    data-cedula="{{ p.cedula }}"
                                    data-email="{{ p.email }}"
                                    data-phone="{{ p.telefono }}"
                                    data-city="{{ p.perfil_cliente.ciudad }}"
                                    data-address="{{ p.perfil_cliente.direccion }}"
                                    data-map="{{ p.perfil_cliente.google_maps_link|default:'' }}"
                                    data-allergies="{{ p.perfil_cliente.alergias|default:'Ninguna' }}"
                                    title="Ver Detalles">
                                <i class="fas fa-eye"></i>
                            </button>

                            <a href="{% url 'admin_patient_update' p.pk %}" class="btn btn-sm btn-default btn-hover-warning" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>

                            <a href="{% url 'admin_patient_delete' p.pk %}" class="btn btn-sm btn-default btn-hover-danger" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modal-patient-details" role="dialog" tabindex="-1" aria-labelledby="demo-default-modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal"><i class="pci-cross pci-circle"></i></button>
                <h4 class="modal-title text-white"><i class="fa fa-user-circle"></i> Ficha del Paciente</h4>
            </div>

            <div class="modal-body">
                <div class="text-center mar-btm">
                    <img id="modal-img" src="" class="img-circle img-lg border-white" style="border: 3px solid #fff; box-shadow: 0 0 5px rgba(0,0,0,0.2);">
                    <h3 id="modal-name" class="text-main text-bold mar-no"></h3>
                    <p id="modal-cedula" class="text-muted"></p>
                </div>
                
                <hr>

                <div class="row">
                    <div class="col-sm-6">
                        <p class="text-main text-bold text-uppercase text-xs">Contacto</p>
                        <ul class="list-unstyled">
                            <li><i class="fa fa-envelope icon-fw"></i> <span id="modal-email"></span></li>
                            <li><i class="fa fa-phone icon-fw"></i> <span id="modal-phone"></span></li>
                        </ul>
                    </div>
                    <div class="col-sm-6">
                        <p class="text-main text-bold text-uppercase text-xs">Ubicación</p>
                        <ul class="list-unstyled">
                            <li><i class="fa fa-building icon-fw"></i> <span id="modal-city"></span></li>
                            <li><i class="fa fa-map-marker icon-fw"></i> <span id="modal-address"></span></li>
                        </ul>
                        <div id="modal-map-container" class="pad-top hidden">
                            <a id="modal-map-link" href="#" target="_blank" class="btn btn-xs btn-success">
                                <i class="fa fa-external-link"></i> Ver en Google Maps
                            </a>
                        </div>
                    </div>
                </div>

                <hr>

                <div>
                    <p class="text-main text-bold text-uppercase text-xs text-danger">Alergias / Observaciones Médicas</p>
                    <div class="well well-sm bg-gray-light">
                        <p id="modal-allergies" class="mar-no"></p>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button data-dismiss="modal" class="btn btn-default" type="button">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'plugins/datatables/media/js/jquery.dataTables.js' %}"></script>
    <script src="{% static 'plugins/datatables/media/js/dataTables.bootstrap.js' %}"></script>
    <script src="{% static 'plugins/datatables/extensions/Responsive/js/dataTables.responsive.min.js' %}"></script>

    <script>
        $(document).ready(function() {
            // Inicializar Tabla
            $('#demo-dt-basic').DataTable({
                "language": {
                    "sProcessing":     "Procesando...",
                    "sLengthMenu":     "Mostrar _MENU_",
                    "sZeroRecords":    "No se encontraron resultados",
                    "sEmptyTable":     "Ningún dato disponible",
                    "sInfo":           "Mostrando _START_ al _END_ de _TOTAL_",
                    "sInfoEmpty":      "0 registros",
                    "sInfoFiltered":   "(de _MAX_ totales)",
                    "sSearch":         "Buscar:",
                    "oPaginate": {
                        "sNext":     "<i class='demo-pli-arrow-right'></i>",
                        "sPrevious": "<i class='demo-pli-arrow-left'></i>"
                    }
                },
                "responsive": true,
                "columnDefs": [
                    { "orderable": false, "targets": 4 } // No ordenar columna acciones
                ]
            });

            // 4. LÓGICA PARA LLENAR EL MODAL
            // Usamos delegación de eventos (on click) por si la tabla pagina y los botones se recrean
            $(document).on('click', '.btn-view-details', function() {
                const btn = $(this);
                
                // Llenar datos básicos
                $('#modal-img').attr('src', btn.data('img'));
                $('#modal-name').text(btn.data('name'));
                $('#modal-cedula').text(btn.data('cedula'));
                $('#modal-email').text(btn.data('email'));
                $('#modal-phone').text(btn.data('phone'));
                $('#modal-city').text(btn.data('city'));
                $('#modal-address').text(btn.data('address'));
                $('#modal-allergies').text(btn.data('allergies'));

                // Manejo del link de mapa
                const mapLink = btn.data('map');
                if (mapLink) {
                    $('#modal-map-link').attr('href', mapLink);
                    $('#modal-map-container').removeClass('hidden');
                } else {
                    $('#modal-map-container').addClass('hidden');
                }
            });
        });
    </script>
{% endblock %}