{% extends 'layouts/dashboard_base.html' %}
{% load static %}

{% block title %}Gestión de Recordatorios{% endblock %}
{% block page_title %}Buzón de Recordatorios y Leads{% endblock %}
{% block breadcrumb %}<li class="active">Recordatorios</li>{% endblock %}

{% block extra_css %}
    <link href="{% static 'plugins/datatables/media/css/dataTables.bootstrap.css' %}" rel="stylesheet">
    <link href="{% static 'plugins/datatables/extensions/Responsive/css/responsive.dataTables.min.css' %}" rel="stylesheet">
    <style>
        .dataTables_filter { text-align: right; }
        .dataTables_paginate { text-align: right; }
        .btn-action-group { white-space: nowrap; }
        /* Estilo para el estado en la tabla */
        .label-lg { font-size: 90%; padding: 5px 10px; }
    </style>
{% endblock %}

{% block content %}
<div class="panel">
    <div class="panel-heading">
        <div class="panel-control">
            <a href="{% url 'admin_reminder_create' %}" class="btn btn-primary">
                <i class="demo-pli-plus"></i> Nuevo Manual
            </a>
        </div>
        <h3 class="panel-title">Listado de Solicitudes</h3>
    </div>

    <div class="panel-body">
        <table id="demo-dt-basic" class="table table-striped table-bordered" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th style="width: 10%;">Estado</th>
                    <th style="width: 20%;">Paciente</th>
                    <th style="width: 25%;">Producto / Servicio</th>
                    <th style="width: 15%;">Fecha Límite</th>
                    <th style="width: 10%;">Origen</th>
                    <th class="text-center" style="width: 20%;" data-orderable="false">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item in recordatorios %}
                <tr>
                    <td id="status-cell-{{ item.id }}" style="vertical-align: middle;">
                        {% if item.estado == 'PENDIENTE' %}
                            <span class="label label-warning label-lg">Pendiente</span>
                        {% elif item.estado == 'AGENDADO' %}
                            <span class="label label-success label-lg">Agendado</span>
                        {% elif item.estado == 'CONTACTADO' %}
                            <span class="label label-info label-lg">Contactado</span>
                        {% elif item.estado == 'CANCELADO' %}
                            <span class="label label-danger label-lg">Cancelado</span>
                        {% else %}
                            <span class="label label-default">{{ item.estado }}</span>
                        {% endif %}
                    </td>

                    <td style="vertical-align: middle;">
                        <span class="text-bold text-main">{{ item.paciente.get_full_name }}</span>
                        {% if item.paciente.cedula %}
                            <br><small class="text-muted">CI: {{ item.paciente.cedula }}</small>
                        {% endif %}
                    </td>

                    <td style="vertical-align: middle;">
                        {% if item.medicamento_catalogo %}
                            <i class="fa fa-medkit text-purple"></i> {{ item.medicamento_catalogo.nombre }}
                        {% else %}
                            <i class="fa fa-tag text-muted"></i> {{ item.medicamento_externo|default:"General" }}
                        {% endif %}
                    </td>

                    <td style="vertical-align: middle;">
                        {% if item.fecha_limite_sugerida %}
                            <span class="text-semibold">{{ item.fecha_limite_sugerida|date:"d M, Y" }}</span>
                            <br>
                            {# Lógica visual simple para fechas pasadas #}
                            {% now "Y-m-d" as todays_date %}
                            {% if item.fecha_limite_sugerida|date:"Y-m-d" < todays_date and item.estado == 'PENDIENTE' %}
                                <span class="text-danger text-xs text-bold"><i class="fa fa-exclamation-circle"></i> Vencido</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">--</span>
                        {% endif %}
                    </td>

                    <td style="vertical-align: middle;">
                        {% if item.origen == 'WEB' %}
                            <span class="badge badge-mint">Web</span>
                        {% else %}
                            <span class="badge badge-dark">Sistema</span>
                        {% endif %}
                    </td>

                    <td class="text-center" style="vertical-align: middle;">
                        <div class="btn-group btn-action-group">
                            
                            {% if item.paciente.telefono %}
                                {# Lógica Template: Si empieza con 09, pon +593 y corta el 0. Si no, pon original #}
                                {% with telf=item.paciente.telefono %}
                                    <a href="https://wa.me/{% if telf|slice:':2' == '09' %}+593{{ telf|slice:'1:' }}{% else %}{{ telf }}{% endif %}?text=Hola {{ item.paciente.first_name }}, le saludamos de HolaEnfermera para recordarle su aplicación de {% if item.medicamento_catalogo %}{{ item.medicamento_catalogo.nombre }}{% else %}{{ item.medicamento_externo }}{% endif %}." 
                                       target="_blank" 
                                       class="btn btn-sm btn-success btn-hover-success" 
                                       title="Chat WhatsApp">
                                        <i class="fa fa-whatsapp fa-lg"></i>
                                    </a>
                                {% endwith %}
                            {% else %}
                                <button class="btn btn-sm btn-default" disabled title="Sin teléfono"><i class="fa fa-whatsapp"></i></button>
                            {% endif %}

                            <button class="btn btn-sm btn-default btn-hover-info btn-view-details"
                                    data-toggle="modal" data-target="#modal-reminder-details"
                                    data-paciente="{{ item.paciente.get_full_name }}"
                                    data-cedula="{{ item.paciente.cedula }}"
                                    data-telefono="{{ item.paciente.telefono }}"
                                    data-producto="{% if item.medicamento_catalogo %}{{ item.medicamento_catalogo.nombre }}{% else %}{{ item.medicamento_externo }}{% endif %}"
                                    data-fecha="{{ item.fecha_limite_sugerida|date:'d/m/Y' }}"
                                    data-notas="{{ item.notas|default:'Sin notas' }}"
                                    data-origen="{{ item.origen }}"
                                    title="Ver Detalles">
                                <i class="fas fa-eye"></i>
                            </button>

                            <button class="btn btn-sm btn-warning btn-hover-warning btn-change-status"
                                    data-toggle="modal" data-target="#modal-change-status"
                                    data-id="{{ item.id }}"
                                    data-current="{{ item.estado }}"
                                    title="Cambiar Estado Rápido">
                                <i class="fa fa-bolt"></i>
                            </button>

                            <a href="{% url 'admin_reminder_update' item.pk %}" class="btn btn-sm btn-default btn-hover-primary" title="Editar Completo">
                                <i class="demo-pli-pen-5"></i>
                            </a>
                            
                            <a href="{% url 'admin_reminder_delete' item.pk %}" class="btn btn-sm btn-default btn-hover-danger" title="Eliminar">
                                <i class="demo-pli-trash"></i>
                            </a>

                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modal-reminder-details" role="dialog" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <button type="button" class="close" data-dismiss="modal"><i class="pci-cross pci-circle"></i></button>
                <h4 class="modal-title text-white"><i class="fa fa-file-text-o"></i> Ficha del Recordatorio</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-6">
                        <p class="text-main text-bold text-uppercase text-xs">Paciente</p>
                        <h4 id="det-paciente" class="text-primary mar-no"></h4>
                        <p id="det-cedula" class="text-muted"></p>
                        <p><i class="fa fa-phone"></i> <span id="det-telefono"></span></p>
                    </div>
                    <div class="col-sm-6 bg-gray-light pad-all rounded">
                        <p class="text-main text-bold text-uppercase text-xs">Recordatorio</p>
                        <p><strong>Producto:</strong> <span id="det-producto"></span></p>
                        <p><strong>Fecha Límite:</strong> <span id="det-fecha" class="text-danger text-bold"></span></p>
                        <p><strong>Origen:</strong> <span id="det-origen" class="badge badge-dark"></span></p>
                    </div>
                </div>
                <hr>
                <p class="text-main text-bold text-uppercase text-xs">Notas / Observaciones</p>
                <div class="well well-sm">
                    <p id="det-notas" class="mar-no"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button data-dismiss="modal" class="btn btn-default" type="button">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-change-status" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <button type="button" class="close" data-dismiss="modal"><i class="pci-cross pci-circle"></i></button>
                <h4 class="modal-title text-white">Gestionar Estado</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="status-reminder-id">
                <p class="text-center">Seleccione el nuevo estado:</p>
                <div class="list-group">
                    <button type="button" class="list-group-item list-group-item-action text-center" onclick="updateStatus('PENDIENTE')">
                        <span class="label label-warning">Pendiente</span>
                    </button>
                    <button type="button" class="list-group-item list-group-item-action text-center" onclick="updateStatus('AGENDADO')">
                        <span class="label label-success">Agendado</span>
                    </button>
                    <button type="button" class="list-group-item list-group-item-action text-center" onclick="updateStatus('CONTACTADO')">
                        <span class="label label-info">Contactado</span>
                    </button>
                    <button type="button" class="list-group-item list-group-item-action text-center" onclick="updateStatus('CANCELADO')">
                        <span class="label label-danger">Cancelado</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
    <script src="{% static 'plugins/datatables/media/js/jquery.dataTables.js' %}"></script>
    <script src="{% static 'plugins/datatables/media/js/dataTables.bootstrap.js' %}"></script>
    <script src="{% static 'plugins/datatables/extensions/Responsive/js/dataTables.responsive.min.js' %}"></script>

    <script>
        $(document).ready(function() {
            // 1. Inicializar DataTable
            $('#demo-dt-basic').DataTable({
                "language": {
                    "sProcessing": "Procesando...",
                    "sLengthMenu": "Mostrar _MENU_",
                    "sZeroRecords": "No se encontraron resultados",
                    "sEmptyTable": "Ningún dato disponible",
                    "sInfo": "Mostrando _START_ al _END_ de _TOTAL_",
                    "sInfoEmpty": "0 registros",
                    "sInfoFiltered": "(de _MAX_ totales)",
                    "sSearch": "Buscar:",
                    "oPaginate": { "sNext": ">", "sPrevious": "<" }
                },
                "responsive": true,
                "order": [[ 0, "asc" ]], // Ordenar por estado por defecto
                "columnDefs": [ { "orderable": false, "targets": 5 } ]
            });

            // 2. Lógica Modal Detalles (Delegación de eventos)
            $(document).on('click', '.btn-view-details', function() {
                const btn = $(this);
                $('#det-paciente').text(btn.data('paciente'));
                $('#det-cedula').text(btn.data('cedula'));
                $('#det-telefono').text(btn.data('telefono'));
                $('#det-producto').text(btn.data('producto'));
                $('#det-fecha').text(btn.data('fecha'));
                $('#det-notas').text(btn.data('notas'));
                $('#det-origen').text(btn.data('origen'));
            });

            // 3. Lógica Modal Cambio de Estado
            $(document).on('click', '.btn-change-status', function() {
                const btn = $(this);
                $('#status-reminder-id').val(btn.data('id'));
            });
        });

        // 4. Función AJAX para actualizar estado
        function updateStatus(newStatus) {
            const reminderId = $('#status-reminder-id').val();
            const csrfToken = "{{ csrf_token }}";

            // UI Feedback simple
            $('#modal-change-status').modal('hide');

            fetch("{% url 'api_reminder_status' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify({ id: reminderId, estado: newStatus })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    // Recargar página para ver cambios (o actualizar DOM si queremos ser muy pro)
                    // Por simplicidad y para refrescar DataTables correctamente:
                    location.reload();
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(err => alert("Error de conexión"));
        }
    </script>
{% endblock %}